
import { existsSync } from 'fs';
import {
  parallel,
  series,
  task,
  watch,
} from 'gulp';
import { relative, resolve } from 'path';

import {
  cleanTasks,
  faviconTask,
  fontsTask,
  getWatchers,
  iconsTask,
  imagesTask,
  reload,
  scriptsTask,
  serveTask,
  stylesTask,
  translationTask,
	vendorScriptsTask,
} from '@gulppress/scripts';
import config from './gulppress.config';

const nodeEnvFile = require('node-env-file');
if (typeof config.project.envFile === 'string' && config.project.envFile) {
  try {
    if (existsSync(config.project.envFile)) {
      nodeEnvFile(config.project.envFile, { raise: false });
    }
  } catch (err) {
    console.error('.env file not found, please check your configuration');
  }
}

const clean = cleanTasks(config);
config.scripts.dest = resolve(__dirname, config.scripts.dest);
const compileScripts = scriptsTask(config.scripts, config.project);
config.styles.dest = relative(__dirname, config.styles.dest);
const compileStyles = stylesTask(config.styles, config.project);
const processFavicon = faviconTask(config.favicon);
const processFonts = fontsTask(config.fonts);
const processIcons = iconsTask(config.icons);
const processImages = imagesTask(config.images);
const startServer = serveTask(config.browserSync);
const processTranslations = translationTask(config.translation);
const processVendorScripts = vendorScriptsTask(config.vendorScripts, config.project);

// task('watch', function (this: any) {
task('watch', () => {
  const watchers = getWatchers();
  if (watchers.styles) {
    watch(config.styles.watch, series(compileStyles));
  }
  if (watchers.icons) {
    watch(config.icons.src, series(processIcons));
  }
  if (watchers.images) {
    watch(config.images.src, series(processImages));
  }
});

task('dev', series(
  clean.scriptsStyles,
  parallel(
    compileScripts,
    compileStyles,
    'watch',
    startServer,
  ),
));

task('assets', series(
  clean.assets,
  parallel(
    processFavicon,
    processFonts,
    processIcons,
    processImages,
    processTranslations,
		processVendorScripts,
  ),
));

task('build', series(
  clean.all,
  parallel(
    compileScripts,
    compileStyles,
    'assets',
  ),
));

task('default', series('build'));

task('clean', series(clean.all));
task('favicon', processFavicon);
task('fonts', processFonts);
task('icons', processIcons);
task('images', processImages);
task('scripts', compileScripts);
task('serve', startServer);
task('styles', compileStyles);
task('translate', processTranslations);
task('vendorScripts', processVendorScripts);
